#!/bin/bash

### An alias for grep ###
grep=/usr/bin/grep
CONF="./test"
### Varibles needed before ANYTHING else ###

#Sets up an array to parse the default loader


### Start function definitions ###
setup() {
  $echo "Have you setup snapper? [Y/N], (choosing N will configure it)"
  read $input1
  if [  "$input1" = "N"  ]; then
    /usr/bin/snapper -c
    /usr/bin/systemctl enable snapper-boot.timer
    /usr/bin/systemctl enable snapper-cleanup.timer
    $echo "Snapper setup!"
  else
    $echo "Look at you, being prepared and all"
    $echo " "
  fi
}

print_help () {
  # Does just what it says it does, prints the help 'menu' if one can call it that
  $echo "useage: snapper-menu-update <option>"
  $echo "options:"
  $echo "-r, --run: just runs the script with either the defaults or what you have setup"
  $echo "-s, --setup: sets up what to use as the variables for the file name, etc; makes sure snapper is configured"
  $echo "-h, --help: prints this message"
}

grab_from_loader() {
  # It snatches whatever info we need from the default loader file
  $grep "$1" $DEFAULT_LOADER
}

defalt_variables() {
  # This is to get the subvolume which the root is on
  ROOT_SUBVOL_STNG=$(/usr/bin/btrfs sub get-default / )
  ROOT_SUBVOL=${ROOT_SUBVOL_STNG##*path }
  #### Done with viable declarations #####
}

generate_conf() {

  cat_to_conf() {
    $echo "$1" >> $CONF
  }
  LOADER_FOLDER="/boot/loader"
  defualt_loader_array=( $($grep default $LOADER_FOLDER/loader.conf) )
  #Set the default loader
  DEFAULT_LOADER="$LOADER_FOLDER/entries/${defualt_loader_array[1]}.conf"
  TITLE="Well crap . . ."
  #TARGET_FILE="$LOADER_FOLDER/entries/boot_snapshot.conf"
  TARGET_FILE="test_loader.conf"
  OPTIONS=$(grab_from_loader options)
  LINUX=$(grab_from_loader "linux ")
  INITRD=$( (grab_from_loader initrd) )
  declare -a initrd_files
  # This checks the INITRD array for all of the entries which are not the word "initrd" and
  # adds them to the initrd_files array
  for i in ${INITRD[@]}; do
    if [ "$i" != "initrd" ]; then
      initrd_files+=($i)
    fi
  done

  $echo "# This is where you can change the values for the snapper-menu-option" > $CONF
  cat_to_conf "TITLE='$TITLE'"
  cat_to_conf "LOADER_FOLDER='$LOADER_FOLDER'"
  cat_to_conf "TARGET_FILE='$TARGET_FILE'"
  cat_to_conf "OPTIONS='$OPTIONS'"
  cat_to_conf "LINUX='$LINUX'"
  $echo "INIRD=(${initrd_files[@]})" >> $CONF
}

update_file () {
  # Source the conf file. In theory this will overide the defaults just set if
  # the defaults have changed

  source $CONF
  latestboot_array=( $(/usr/bin/snapper -c root list |
  $grep boot |
  /usr/bin/cut -b -5 |
  /usr/bin/sort -nr))
  latestboot_array=( 3 34 553 343 )
  $echo $TITLE
  $echo $LINUX
  $echo ${INIRD[*]}
  $echo "title $TITLE (snapshot # ${latestboot_array[0]} )" > $TARGET_FILE
  #The rest are 2 carrots to just cat onto the end of the file
  $echo $LINUX >> $TARGET_FILE
  #Copies the initrd files one line at a time
  for i in ${initrd_files[@]}; do
    $echo "initrd "$i" " >> $TARGET_FILE
  done
  # Just adds the rootflag option at the end
  $echo "$OPTIONS rootflags=subvol=$ROOT_SUBVOL/.snapshots/${latestboot_array[0]}" >> $TARGET_FILE
}
### End function definitions ###
#This switch statement merely signals what part of the command to run
case "$1" in
  "-h" | "--help")
  print_help
  ;;
  "-s" | "--setup")
  setup
  ;;
  "-g" | "--generate")
  generate_conf
  ;;
  "-r" | "--run")
  update_file
  ;;
  * )
  $echo "command not recongized, try -h or --help for more"
  ;;
esac
